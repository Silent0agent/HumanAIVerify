{% extends "base.html" %}
{% load i18n static thumbnail %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/tasks.css' %}">
{% endblock extra_head %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="fs-5 fw-semibold">
      <span class="fw-normal">
        {% block my_tasks %}
        {% endblock my_tasks %}
      </span>
      <span class="text-muted mx-1">/</span>
      <span class="text-muted mx-1 fw-normal">{{ task.title }}</span>
    </div>
  </div>

  <div class="card border-0 shadow-lg rounded-4 mb-5 overflow-hidden">
    <div class="card-body p-4 p-lg-5">
      <div class="row g-4 align-items-stretch">

        <div class="col-lg-5" data-bs-toggle="modal" data-bs-target="#taskContentExpand">
          <div class="h-100 rounded-4 bg-secondary hover-lift d-flex align-items-center justify-content-center p-4">
            <div class="w-100 text-center overflow-hidden">
              {% block task_content %}
              {% endblock task_content %}
            </div>
          </div>
        </div>

        <div class="col-lg-7 d-flex flex-column gap-4">

          <div class="rounded-4 card p-4 text-center hover-lift shadow-md" data-bs-toggle="modal" data-bs-target="#taskDescriptionExpand">
            <div class="text-uppercase text-muted small mb-2">{% translate "Description" %}</div>
            {% if task.description %}
              <div class="fs-6 fw-medium">{{ task.description|linebreaksbr|truncatechars:64 }}</div>
            {% else %}
              <em class="text-muted">{% translate "no_task_description" %}</em>
            {% endif %}
          </div>

          <div class="row row-cols-2 row-cols-md-3 g-3">

            <div class="col">
              <div class="border rounded-4 p-3 text-center h-100 hover-lift">
                <div class="text-muted small mb-1">{% translate "Created" %}</div>
                <div class="fw-semibold">
                  <i class="bi bi-calendar-event me-1"></i><span class="fs-6 fw-normal">{{ task.created_at|date:"d.m.Y" }}</span>
                </div>
              </div>
            </div>

            <div class="col">
              <div class="border rounded-4 p-3 text-center h-100 hover-lift">
                <div class="text-muted small mb-1">{% translate "AI_score" %}</div>
                {% if task.ai_score is not None %}
                  {% if task.ai_score >= 70 %}
                    <div class="fw-bold text-danger fs-5">
                      <i class="bi bi-cpu me-1"></i>{{ task.ai_score|floatformat:0 }}%
                    </div>
                  {% elif task.ai_score >= 30 %}
                    <div class="fw-bold text-warning fs-5">
                      <i class="bi bi-cpu me-1"></i>{{ task.ai_score|floatformat:0 }}%
                    </div>
                  {% else %}
                    <div class="fw-bold text-success fs-5">
                      <i class="bi bi-cpu me-1"></i>{{ task.ai_score|floatformat:0 }}%
                    </div>
                  {% endif %}
                {% else %}
                  <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary border px-3 py-2">
                    <i class="bi bi-hourglass me-1"></i><span class="fs-6 fw-normal">{% translate "Not_checked" %}</span>
                  </span>
                {% endif %}
              </div>
            </div>

            <div class="mx-auto">
              <div class="border rounded-4 p-3 text-center h-100 hover-lift">
                <div class="text-muted small mb-1">{% translate "Checks" %}</div>
                <div class="fw-semibold fs-5">
                  <i class="bi bi-people me-1"></i><span class="fs-4 fw-normal">{{ task.checks_count }}</span>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-3 px-1">
    <h4 class="mb-0">{% translate "Checks_history" %}</h4>
  </div>

  {% if task.checks.all %}
    <div class="card border-0 shadow rounded-4 overflow-hidden">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 text-uppercase small text-muted">ID</th>
              <th class="text-uppercase small text-muted">{% translate "Performer" %}</th>
              <th class="text-uppercase small text-muted">{% translate "Score" %}</th>
              <th class="text-uppercase small text-muted">{% translate "Comment" %}</th>
              <th class="text-uppercase small text-muted text-nowrap">{% translate "Date" %}</th>
              <th class="pe-4 text-end text-uppercase small text-muted">{% translate "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for check in task.checks.all %}
              <tr class="hover-shadow">
                <td class="ps-4 text-muted">#{{ check.id }}</td>
                <td class="fw-medium">
                  <div class="tasks-performer" onclick="window.location.href='{% url 'users:user-detail' check.performer.id %}'">
                    {% if check.performer.avatar %}
                      {% thumbnail check.performer.avatar "30x30" crop="center" upscale=True as avatar %}
                        <img src="{{ avatar.url }}" alt="Avatar" width="{{ avatar.width }}" height="{{ avatar.height }}" class="rounded-circle me-2">
                      {% endthumbnail %}
                    {% else %}
                      <img src="{% static 'img/no_avatar.png' %}" alt="{% translate 'avatar_not_found' %}" width="30" height="30" class="rounded-circle me-2">
                    {% endif %}
                    {{ check.performer.username }}
                  </div>
                </td>
                <td>
                  {% if task.ai_score >= 70 %}
                    <span class="badge rounded-pill fw-normal fs-6 bg-success border">{{ check.ai_score|floatformat:1 }}%</span>
                  {% elif task.ai_score >= 30 %}
                    <span class="badge rounded-pill fw-normal fs-6 bg-warning border">{{ check.ai_score|floatformat:1 }}%</span>
                  {% else %}
                    <span class="badge rounded-pill fw-normal fs-6 bg-success border">{{ check.ai_score|floatformat:1 }}%</span>
                  {% endif %}
                </td>
                <td>
                  {% if check.comment %}
                    <span class="d-inline-block text-truncate" style="max-width:300px" title="{{ check.comment }}">{{ check.comment }}</span>
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
                <td class="text-nowrap text-muted small">{{ check.updated_at|date:"d.m.Y" }}</td>
                <td class="pe-4 text-end">
                  {% block view_details %}
                  {% endblock view_details %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% else %}
    <div class="border rounded-4 text-center py-5 text-muted">
      <i class="bi bi-clipboard-x display-5 d-block mb-3"></i>
      {% translate "No_checks" %}
    </div>
  {% endif %}

  {% block task_content_expand %}
  {% endblock task_content_expand %}
  <div class="modal fade" id="taskDescriptionExpand" tabindex="-1" aria-labelledby="taskDescriptionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content rounded-3">
        <div class="modal-header">
          <h5 class="modal-title" id="taskContentLabel">{% translate "Description" %} — {{ task.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% translate 'Close' %}"></button>
        </div>
        <div class="modal-body">{{ task.description|linebreaksbr }}</div>
      </div>
    </div>
  </div>

{% endblock content %}
